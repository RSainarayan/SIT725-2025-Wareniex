<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Dashboard</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/components/dashboard/dashboard.css">
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">Warehouse</a>
				<div class="collapse navbar-collapse">
								<ul class="navbar-nav ms-auto">
									<li class="nav-item"><a class="nav-link" href="/products">Products</a></li>
									<li class="nav-item"><a class="nav-link" id="userEmail" href="#"></a></li>
									<li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
								</ul>
				</div>
			</div>
		</nav>

		<div class="container mt-4">
			<h1 class="mb-3">Dashboard</h1>

			<div class="row g-3">
				<!-- Include dashboard cards component -->
				<div class="col-md-4" id="card-1"></div>
				<div class="col-md-4" id="card-2"></div>
				<div class="col-md-4" id="card-3"></div>
			</div>

			<section class="mt-4">
				<h2>Recent Products</h2>
				<div id="recent-products" class="recent-products-list">Loading...</div>
			</section>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>

		<!-- Load dashboard component and simple client script -->
		<script>
			// fetch and insert component HTML into placeholders
			async function loadCard(id, title, value) {
				const resp = await fetch('/components/dashboard/dashboard-card.html');
				const text = await resp.text();
				const html = text.replace('{{title}}', title).replace('{{value}}', value);
				document.getElementById(id).innerHTML = html;
			}

			// Update total products card with real-time quantity
			async function updateTotalProductsCard() {
				try {
					const resp = await fetch('/products/data/total-quantity');
					const data = await resp.json();
					loadCard('card-1', 'Total Products', data.totalQuantity);
				} catch (e) {
					loadCard('card-1', 'Total Products', '—');
				}
			}
			updateTotalProductsCard();

			loadCard('card-2', 'Low Stock', '—');
			loadCard('card-3', 'Pending Orders', '—');

			// Load recent products from /products (rendered HTML) as a quick demo
			async function loadRecent() {
				const resp = await fetch('/products');
				const text = await resp.text();
				// updated: find the products list from returned HTML with class selector
				const match = text.match(/<ul class="product-list">[\s\S]*?<\/ul>/);
				document.getElementById('recent-products').innerHTML = match ? match[0] : 'No data';
			}
			loadRecent();

					// show logged in user
					(async function () {
						try {
							const r = await fetch('/me');
							if (!r.ok) return;
							const u = await r.json();
							document.getElementById('userEmail').textContent = u.email || '';
							document.getElementById('userEmail').href = '#';
						} catch (e) {}
					})();

      const socket = io();
      socket.on('productCreated', function(product) {
        updateTotalProductsCard();
        loadRecent();
      });
      socket.on('productDeleted', function(data) {
        updateTotalProductsCard();
        loadRecent();
      });
		</script>

			<style>
				.recent-products-list ul.product-list {
					list-style: none;
					padding: 0;
					margin: 0;
				}
				.recent-products-list ul.product-list li {
					background: #f1f5f9;
					margin-bottom: 12px;
					padding: 16px;
					border-radius: 6px;
					display: flex;
					justify-content: space-between;
					align-items: center;
					box-shadow: 0 1px 3px rgba(0,0,0,0.04);
				}
				.recent-products-list .product-info {
					flex: 1;
				}
				.recent-products-list .product-name {
					font-weight: 500;
					color: #2563eb;
					text-decoration: none;
				}
				.recent-products-list .product-meta {
					color: #64748b;
					font-size: 14px;
					margin-top: 4px;
				}
				.recent-products-list .no-products {
					text-align: center;
					color: #64748b;
					margin-top: 32px;
				}
			</style>
	</body>
</html>
