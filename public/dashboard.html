<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Dashboard</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
		<link rel="stylesheet" href="/components/dashboard/dashboard.css">
	</head>
	<body>
		<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
			<div class="container-fluid">
				<a class="navbar-brand" href="#">WARENIX - Inventory Automation System</a>
				<div class="collapse navbar-collapse">
								<ul class="navbar-nav ms-auto">
									<li class="nav-item"><a class="nav-link" href="/products">Products</a></li>
									<li class="nav-item"><a class="nav-link btn btn-sm btn-outline-light ms-2" href="/stock-intake">Stock Intake</a></li>
									<li class="nav-item"><a class="nav-link" id="userEmail" href="#"></a></li>
									<li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
									<li class="nav-item"><a class="nav-link" id="adminNav" href="/admin" style="display:none">Admin</a></li>
								</ul>
				</div>
			</div>
		</nav>

		<div class="container mt-4">
			<h1 class="mb-3">Dashboard</h1>

			<div class="row g-3">
				<!-- Include dashboard cards component -->
				<div class="col-md-4" id="card-1"></div>
				<div class="col-md-4" id="card-2"></div>
				<div class="col-md-4" id="card-3"></div>
				<div class="col-md-4">
					<div class="card">
						<div class="card-body text-center">
							<h5 class="card-title">Live User Count</h5>
							<div id="live-user-count" style="font-size:2rem;">—</div>
						</div>
					</div>
				</div>
			</div>

			<section class="mt-4">
				<h2>Recent Products</h2>
				<div id="recent-products" class="recent-products-table">Loading...</div>
			</section>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>

		<!-- Load dashboard component and simple client script -->
		<script>
			// fetch and insert component HTML into placeholders
			async function loadCard(id, title, value) {
				const resp = await fetch('/components/dashboard/dashboard-card.html');
				const text = await resp.text();
				const html = text.replace('{{title}}', title).replace('{{value}}', value);
				document.getElementById(id).innerHTML = html;
			}

			// Update total products card with real-time quantity
			async function updateTotalProductsCard() {
				try {
					const resp = await fetch('/products/data/total-quantity');
					const data = await resp.json();
					loadCard('card-1', 'Total Products', data.totalQuantity);
				} catch (e) {
					loadCard('card-1', 'Total Products', '—');
				}
			}
			updateTotalProductsCard();

			loadCard('card-2', 'Low Stock', '—');
			loadCard('card-3', 'Pending Orders', '—');

			// Load recent products from /products/data API endpoint
			async function loadRecent() {
				const resp = await fetch('/products/data');
				const products = await resp.json();
				if (!products.length) {
					document.getElementById('recent-products').innerHTML = '<div class="no-products">No products found</div>';
					return;
				}
				let table = `<table><thead><tr><th>Name</th><th>SKU</th><th>Quantity</th><th>Weight (kg)</th></tr></thead><tbody>`;
				for (const p of products) {
					table += `<tr><td><a href="/products/${p._id}" class="product-name">${p.name}</a></td><td>${p.sku}</td><td>${p.quantity}</td><td>${p.weight != null ? p.weight : 0}</td></tr>`;
				}
				table += '</tbody></table>';
				document.getElementById('recent-products').innerHTML = table;
			}
			loadRecent();

					// show logged in user
					(async function () {
  try {
    const r = await fetch('/me');
    if (!r.ok) return;
    const u = await r.json();
    document.getElementById('userEmail').textContent = u.email || '';
    document.getElementById('userEmail').href = '#';
    if (u.role === 'admin') {
      document.getElementById('adminNav').style.display = '';
    } else {
      document.getElementById('adminNav').style.display = 'none';
    }
  } catch (e) { console.error(e); }
})();

      const socket = io();
      socket.on('productCreated', function(product) {
        updateTotalProductsCard();
        loadRecent();
      });
      socket.on('productDeleted', function(data) {
        updateTotalProductsCard();
        loadRecent();
      });
      socket.on('userCount', function(count) {
        document.getElementById('live-user-count').textContent = count;
      });
		</script>

			<style>
				.recent-products-table table {
					width: 100%;
					border-collapse: collapse;
					background: #fff;
					box-shadow: 0 2px 8px rgba(0,0,0,0.08);
					border-radius: 8px;
					overflow: hidden;
				}
				.recent-products-table th, .recent-products-table td {
					padding: 12px 16px;
					text-align: left;
					border-bottom: 1px solid #e2e8f0;
				}
				.recent-products-table th {
					background: #f1f5f9;
					color: #2563eb;
					font-weight: 600;
				}
				.recent-products-table tr:last-child td {
					border-bottom: none;
				}
				.recent-products-table .product-name {
					color: #2563eb;
					font-weight: 500;
					text-decoration: none;
				}
				.recent-products-table .no-products {
					text-align: center;
					color: #64748b;
					padding: 24px;
				}
			</style>
	</body>
</html>
